<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Game - Archive Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 800px; margin-top: 40px; margin-bottom: 40px; }
        .preview-img { max-width: 100%; max-height: 200px; object-fit: contain; display: none; margin-top: 10px; border-radius: 5px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <div class="container bg-white p-5 rounded shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-primary">Add New Game to Archive</h2>
            <a href="index.html" class="btn btn-outline-secondary">Back to Archive</a>
        </div>

        <form id="addGameForm">
            <div class="row g-3 mb-3">
                <div class="col-md-8">
                    <label class="form-label">Game Title</label>
                    <input type="text" class="form-control" id="gameTitle" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Year</label>
                    <input type="number" class="form-control" id="year" value="2025" required>
                </div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Institution</label>
                    <select class="form-select" id="institution">
                        <option value="UCLA">UCLA</option>
                        <option value="NYU">NYU</option>
                        <option value="USC">USC</option>
                        <option value="Independent">Independent</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Genre</label>
                    <select class="form-select" id="gameGenre">
                        <option value="Platformer">Platformer</option>
                        <option value="Puzzle">Puzzle</option>
                        <option value="RPG">RPG</option>
                        <option value="Action">Action</option>
                        <option value="Adventure">Adventure</option>
                        <option value="Narrative">Narrative</option>
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Creators <small class="text-muted">(Separate names with commas)</small></label>
                <input type="text" class="form-control" id="creators" placeholder="e.g. Alex Chen, Maya Singh">
            </div>

            <div class="mb-4 p-3 bg-light rounded border">
                <label class="form-label fw-bold">Game Screenshot</label>
                <input type="file" class="form-control" id="imageFile" accept="image/*" multiple>
                <img id="imagePreview" class="preview-img" src="#">
                <div class="form-text">Uploading will happen automatically when you click Publish.</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Artist's Statement / Description</label>
                <textarea class="form-control" id="description" rows="4" required></textarea>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label class="form-label">Video Link (YouTube)</label>
                    <input type="url" class="form-control" id="videoLink" placeholder="https://youtube.com/...">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Repo Link (GitHub)</label>
                    <input type="url" class="form-control" id="repoLink" placeholder="https://github.com/...">
                </div>
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    Publish Game
                </button>
            </div>
            
            <div id="statusMessage" class="mt-3 text-center fw-bold"></div>
        </form>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION (Paste your keys here)
        // ==========================================
const PROJECT_URL = 'https://xylhehjbonypyjiyhkkt.supabase.co/';
const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5bGhlaGpib255cHlqaXloa2t0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjkxNjEsImV4cCI6MjA3ODY0NTE2MX0.rWKrKSOCJBLVMPgSt5TAjjIYdFr6tO2Y7V0lQPDz9As';
        // ==========================================

        const supabaseClient = supabase.createClient(PROJECT_URL, ANON_KEY);

        // Preview Image Logic
        const imageInput = document.getElementById('imageFile');
        const imagePreview = document.getElementById('imagePreview');

        imageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        // Main Upload & Submit Logic
        document.getElementById('addGameForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('submitBtn');
            const status = document.getElementById('statusMessage');
            
            // Disable button to prevent double clicks
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';
            status.className = 'mt-3 text-center text-muted';
            status.innerText = "Uploading image...";

            try {
                // 1. Handle Image Upload (if a file was selected)
                let publicImageURL = null;
                const file = imageInput.files[0];

                if (file) {
                    // Create unique filename: "timestamp-filename.jpg"
                    const fileName = `${Date.now()}-${file.name.replace(/\s/g, '_')}`;
                    
                    // Upload to 'supagame' bucket
                    const { data, error: uploadError } = await supabaseClient
                        .storage
                        .from('games')
                        .upload(fileName, file);

                    if (uploadError) throw uploadError;

                    // Get the public URL
                    const { data: urlData } = await supabaseClient
                        .storage
                        .from('games')
                        .getPublicUrl(fileName);
                    
                    publicImageURL = urlData.publicUrl;
                }

                // 2. Prepare Database Record
                // Parse the comma-separated creators string into an array
                const creatorsArray = document.getElementById('creators').value
                    .split(',')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);

                const newGame = {
                    gameTitle: document.getElementById('gameTitle').value,
                    year: parseInt(document.getElementById('year').value),
                    institution: document.getElementById('institution').value,
                    gameGenre: document.getElementById('gameGenre').value,
                    creators: creatorsArray,
                    description: document.getElementById('description').value,
                    videoLink: document.getElementById('videoLink').value || null,
                    repoLink: document.getElementById('repoLink').value || null,
                    // If we have an image, put it in an array (to match your text[] column)
                    image_urls: publicImageURL ? [publicImageURL] : [] 
                };

                status.innerText = "Saving to database...";

                // 3. Insert into Supabase
                const { error: dbError } = await supabaseClient
                    .from('games')
                    .insert([newGame]);

                if (dbError) throw dbError;

                // Success!
                status.className = 'mt-3 text-center text-success fw-bold';
                status.innerHTML = 'Success! Game published. <a href="index.html">View Archive</a>';
                btn.innerHTML = 'Publish Game'; // Reset button text
                
                // Optional: Reset form
                document.getElementById('addGameForm').reset();
                imagePreview.style.display = 'none';

            } catch (err) {
                console.error(err);
                status.className = 'mt-3 text-center text-danger fw-bold';
                status.innerText = 'Error: ' + err.message;
                btn.disabled = false;
                btn.innerHTML = 'Publish Game';
            }
        });
    </script>
</body>
</html>