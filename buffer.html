<body>

    <div class="container bg-white p-5 rounded shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-primary">Add New Game to Archive</h2>
            <a href="index.html" class="btn btn-outline-secondary">Back to Archive</a>
        </div>

        <form id="addGameForm">
            <div class="row g-3 mb-3">
                <div class="col-md-8">
                    <label class="form-label">Game Title</label>
                    <input type="text" class="form-control" id="gameTitle" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Year</label>
                    <input type="number" class="form-control" id="year" value="2025" required>
                </div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Institution</label>
                    <select class="form-select" id="institution">
                        <option value="UCLA">UCLA</option>
                        <option value="NYU">NYU</option>
                        <option value="USC">USC</option>
                        <option value="Independent">Independent</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Genre</label>
                    <select class="form-select" id="gameGenre">
                        <option value="Platformer">Platformer</option>
                        <option value="Puzzle">Puzzle</option>
                        <option value="RPG">RPG</option>
                        <option value="Action">Action</option>
                        <option value="Adventure">Adventure</option>
                        <option value="Narrative">Narrative</option>
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Creators <small class="text-muted">(Separate names with commas)</small></label>
                <input type="text" class="form-control" id="creators" placeholder="e.g. Alex Chen, Maya Singh">
            </div>

            <div class="mb-4 p-3 bg-light rounded border">
                <label class="form-label fw-bold">Game Screenshots</label>
                <input type="file" class="form-control" id="imageFile" accept="image/*" multiple>
                <div class="form-text text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Max size per file: 1MB. Larger files will be rejected.
                </div>
                <div id="previewContainer" class="d-flex flex-wrap gap-2 mt-2"></div>
            </div>

            <div class="mb-3">
                <label class="form-label">Artist's Statement / Description</label>
                <textarea class="form-control" id="description" rows="4" required></textarea>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label class="form-label">Video Link (YouTube)</label>
                    <input type="url" class="form-control" id="videoLink" placeholder="https://youtube.com/...">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Repo Link (GitHub)</label>
                    <input type="url" class="form-control" id="repoLink" placeholder="https://github.com/...">
                </div>
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    Publish Game
                </button>
            </div>
            
            <div id="statusMessage" class="mt-3 text-center fw-bold"></div>
        </form>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
const PROJECT_URL = 'https://xylhehjbonypyjiyhkkt.supabase.co/';
const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5bGhlaGpib255cHlqaXloa2t0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjkxNjEsImV4cCI6MjA3ODY0NTE2MX0.rWKrKSOCJBLVMPgSt5TAjjIYdFr6tO2Y7V0lQPDz9As';
        const BUCKET_NAME = 'game-images'; 
        // ==========================================

        const supabaseClient = supabase.createClient(PROJECT_URL, ANON_KEY);
        const MAX_SIZE_BYTES = 1024 * 1024; // 1MB

        // Preview Image Logic (Updated for Multiple)
        const imageInput = document.getElementById('imageFile');
        const previewContainer = document.getElementById('previewContainer');

        imageInput.addEventListener('change', function() {
            previewContainer.innerHTML = ''; // Clear previous previews
            const files = Array.from(this.files);

            files.forEach(file => {
                if (file.size > MAX_SIZE_BYTES) {
                    alert(`Warning: "${file.name}" is too large (${(file.size / 1024 / 1024).toFixed(2)}MB). Please choose a file under 1MB.`);
                    this.value = ''; // Clear input
                    previewContainer.innerHTML = ''; // Clear previews
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-img';
                    img.style.height = '100px';
                    img.style.border = '1px solid #ccc';
                    img.style.borderRadius = '4px';
                    previewContainer.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
        });

        // Main Upload & Submit Logic
        document.getElementById('addGameForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('submitBtn');
            const status = document.getElementById('statusMessage');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';
            status.className = 'mt-3 text-center text-muted';
            status.innerText = "Uploading images...";

            try {
                const uploadedURLs = [];
                const files = Array.from(imageInput.files);

                // 1. Validate Size AGAIN (Security check)
                for (const file of files) {
                    if (file.size > MAX_SIZE_BYTES) {
                        throw new Error(`File "${file.name}" exceeds the 1MB limit.`);
                    }
                }

                // 2. Upload Loop
                for (const file of files) {
                    // Create unique filename
                    const fileName = `${Date.now()}-${Math.floor(Math.random() * 1000)}-${file.name.replace(/\s/g, '_')}`;
                    
                    const { data, error: uploadError } = await supabaseClient
                        .storage
                        .from(BUCKET_NAME)
                        .upload(fileName, file);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabaseClient
                        .storage
                        .from(BUCKET_NAME)
                        .getPublicUrl(fileName);
                    
                    uploadedURLs.push(urlData.publicUrl);
                }

                // 3. Prepare Database Record
                const creatorsArray = document.getElementById('creators').value
                    .split(',')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);

                const newGame = {
                    gameTitle: document.getElementById('gameTitle').value,
                    year: parseInt(document.getElementById('year').value),
                    institution: document.getElementById('institution').value,
                    gameGenre: document.getElementById('gameGenre').value,
                    creators: creatorsArray,
                    description: document.getElementById('description').value,
                    videoLink: document.getElementById('videoLink').value || null,
                    repoLink: document.getElementById('repoLink').value || null,
                    // Use the array of uploaded URLs
                    image_urls: uploadedURLs 
                };

                status.innerText = "Saving to database...";

                // 4. Insert into Supabase
                const { error: dbError } = await supabaseClient
                    .from('games')
                    .insert([newGame]);

                if (dbError) throw dbError;

                status.className = 'mt-3 text-center text-success fw-bold';
                status.innerHTML = 'Success! Game published. <a href="index.html">View Archive</a>';
                btn.innerHTML = 'Publish Game'; 
                document.getElementById('addGameForm').reset();
                previewContainer.innerHTML = '';

            } catch (err) {
                console.error(err);
                status.className = 'mt-3 text-center text-danger fw-bold';
                status.innerText = 'Error: ' + err.message;
                btn.disabled = false;
                btn.innerHTML = 'Publish Game';
            }
        });
    </script>
</body>